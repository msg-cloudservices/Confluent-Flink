/* Create identity Table */
CREATE TABLE identities (
    TransactionID INT NOT NULL,
    id_01 FLOAT,
    id_02 FLOAT,
    id_03 FLOAT,
    id_04 FLOAT,
    id_05 FLOAT,
    id_06 FLOAT,
    id_07 FLOAT,
    id_08 FLOAT,
    id_09 FLOAT,
    id_10 FLOAT,
    id_11 FLOAT,
    id_12 STRING NOT NULL,
    id_13 FLOAT,
    id_14 FLOAT,
    id_15 STRING NOT NULL,
    id_16 STRING NOT NULL,
    id_17 FLOAT,
    id_18 FLOAT,
    id_19 FLOAT,
    id_20 FLOAT,
    id_21 FLOAT,
    id_22 FLOAT,
    id_23 STRING NOT NULL,
    id_24 FLOAT,
    id_25 FLOAT,
    id_26 FLOAT,
    id_27 STRING NOT NULL,
    id_28 STRING NOT NULL,
    id_29 STRING NOT NULL,
    id_30 STRING NOT NULL,
    id_31 STRING NOT NULL,
    id_32 FLOAT,
    id_33 STRING NOT NULL,
    id_34 STRING NOT NULL,
    id_35 STRING NOT NULL,
    id_36 STRING NOT NULL,
    id_37 STRING NOT NULL,
    id_38 STRING NOT NULL,
    DeviceType STRING NOT NULL,
    DeviceInfo STRING NOT NULL,
    TransactionDT FLOAT,
    `Timestamp` TIMESTAMP(3) NOT NULL,
    PRIMARY KEY (TransactionID) NOT ENFORCED,
    WATERMARK FOR `Timestamp` AS `Timestamp` - INTERVAL '20' SECOND
) WITH ('changelog.mode' = 'append');

/* Create trasaction table */
CREATE TABLE transactions (
    TransactionID INT NOT NULL,
    TransactionAmt FLOAT,
    ProductCD STRING NOT NULL,
    card1 INT,
    card2 FLOAT,
    card3 FLOAT,
    card4 STRING NOT NULL,
    card5 FLOAT,
    card6 STRING NOT NULL,
    addr1 FLOAT,
    addr2 FLOAT,
    dist1 FLOAT,
    dist2 FLOAT,
    P_emaildomain STRING NOT NULL,
    R_emaildomain STRING NOT NULL,
    C1 FLOAT,
    C2 FLOAT,
    C3 FLOAT,
    C4 FLOAT,
    C5 FLOAT,
    C6 FLOAT,
    C7 FLOAT,
    C8 FLOAT,
    C9 FLOAT,
    C10 FLOAT,
    C11 FLOAT,
    C12 FLOAT,
    C13 FLOAT,
    C14 FLOAT,
    D1 FLOAT,
    D2 FLOAT,
    D3 FLOAT,
    D4 FLOAT,
    D5 FLOAT,
    D10 FLOAT,
    D11 FLOAT,
    D15 FLOAT,
    M1 STRING NOT NULL,
    M2 STRING NOT NULL,
    M3 STRING NOT NULL,
    M4 STRING NOT NULL,
    M5 STRING NOT NULL,
    M6 STRING NOT NULL,
    M7 STRING NOT NULL,
    M8 STRING NOT NULL,
    M9 STRING NOT NULL,
    V1 FLOAT,
    V2 FLOAT,
    V3 FLOAT,
    V4 FLOAT,
    V5 FLOAT,
    V6 FLOAT,
    V7 FLOAT,
    V8 FLOAT,
    V9 FLOAT,
    V10 FLOAT,
    V11 FLOAT,
    V12 FLOAT,
    V13 FLOAT,
    V14 FLOAT, 
    V15 FLOAT,
    V16 FLOAT,
    V17 FLOAT,
    V18 FLOAT,
    V19 FLOAT,
    V20 FLOAT,
    V21 FLOAT,
    V22 FLOAT,
    V23 FLOAT,
    V24 FLOAT,
    V25 FLOAT,
    V26 FLOAT,
    V27 FLOAT,
    V28 FLOAT,
    V29 FLOAT,
    V30 FLOAT,
    V31 FLOAT,
    V32 FLOAT,
    V33 FLOAT,
    V34 FLOAT,
    V35 FLOAT,
    V36 FLOAT,
    V37 FLOAT,
    V38 FLOAT,
    V39 FLOAT,
    V40 FLOAT,
    V41 FLOAT,
    V42 FLOAT,
    V43 FLOAT,
    V44 FLOAT,
    V45  FLOAT,
    V46 FLOAT,
    V47 FLOAT,
    V48 FLOAT,
    V49 FLOAT,
    V50 FLOAT,
    V51 FLOAT,
    V52 FLOAT,
    V53 FLOAT,
    V54 FLOAT,
    V55 FLOAT,
    V56 FLOAT,
    V57 FLOAT,
    V58 FLOAT,
    V59 FLOAT,
    V60 FLOAT,
    V61 FLOAT,
    V62 FLOAT,
    V63 FLOAT,
    V64 FLOAT,
    V65 FLOAT,
    V66 FLOAT,
    V67 FLOAT,
    V68 FLOAT,
    V69 FLOAT,
    V70 FLOAT,
    V71 FLOAT,
    V72 FLOAT,
    V73 FLOAT,
    V74 FLOAT,
    V75 FLOAT,
    V76 FLOAT,
    V77 FLOAT,
    V78 FLOAT,
    V79 FLOAT,
    V80 FLOAT,
    V81 FLOAT,
    V82 FLOAT,
    V83 FLOAT,
    V84 FLOAT,
    V85 FLOAT,
    V86 FLOAT,
    V87 FLOAT,
    V88 FLOAT,
    V89 FLOAT,
    V90 FLOAT,
    V91 FLOAT,
    V92 FLOAT,
    V93 FLOAT,
    V94 FLOAT,
    V95 FLOAT,
    V96 FLOAT,
    V97 FLOAT,
    V98 FLOAT,
    V99 FLOAT,
    V100 FLOAT,
    V101 FLOAT,
    V102 FLOAT,
    V103 FLOAT,
    V104 FLOAT,
    V105 FLOAT,
    V106 FLOAT,
    V107 FLOAT,
    V108 FLOAT,
    V109 FLOAT,
    V110 FLOAT,
    V111 FLOAT,
    V112 FLOAT,
    V113 FLOAT,
    V114 FLOAT,
    V115 FLOAT,
    V116 FLOAT,
    V117 FLOAT,
    V118 FLOAT,
    V119 FLOAT,
    V120 FLOAT,
    V121 FLOAT,
    V122 FLOAT,
    V123 FLOAT,
    V124 FLOAT,
    V125 FLOAT,
    V126 FLOAT,
    V127 FLOAT,
    V128 FLOAT,
    V129 FLOAT,
    V130 FLOAT,
    V131 FLOAT,
    V132 FLOAT,
    V133 FLOAT,
    V134 FLOAT,
    V135 FLOAT,
    V136 FLOAT,
    V137 FLOAT,
    V138 FLOAT,
    V139 FLOAT,
    V140 FLOAT,
    V141 FLOAT,
    V142 FLOAT,
    V143 FLOAT,
    V144 FLOAT,
    V145 FLOAT,
    V146 FLOAT,
    V147 FLOAT,
    V148 FLOAT,
    V149 FLOAT,
    V150 FLOAT,
    V151 FLOAT,
    V152 FLOAT,
    V153 FLOAT,
    V154 FLOAT,
    V155 FLOAT,
    V156 FLOAT,
    V157 FLOAT,
    V158 FLOAT,
    V159 FLOAT,
    V160 FLOAT,
    V161 FLOAT,
    V162 FLOAT,
    V163 FLOAT,
    V164 FLOAT,
    V165 FLOAT,
    V166 FLOAT,
    V167 FLOAT,
    V168 FLOAT,
    V169 FLOAT,
    V170 FLOAT,
    V171 FLOAT,
    V172 FLOAT,
    V173 FLOAT,
    V174 FLOAT,
    V175 FLOAT,
    V176 FLOAT,
    V177 FLOAT,
    V178 FLOAT,
    V179 FLOAT,
    V180 FLOAT,
    V181 FLOAT,
    V182 FLOAT,
    V183 FLOAT,
    V184 FLOAT,
    V185 FLOAT,
    V186 FLOAT,
    V187 FLOAT,
    V188 FLOAT,
    V189 FLOAT,
    V190 FLOAT,
    V191 FLOAT,
    V192 FLOAT,
    V193 FLOAT,
    V194 FLOAT,
    V195 FLOAT,
    V196 FLOAT,
    V197 FLOAT,
    V198 FLOAT,
    V199 FLOAT,
    V200 FLOAT,
    V201 FLOAT,
    V202 FLOAT,
    V203 FLOAT,
    V204 FLOAT,
    V205 FLOAT,
    V206 FLOAT,
    V207 FLOAT,
    V208 FLOAT,
    V209 FLOAT,
    V210 FLOAT,
    V211 FLOAT,
    V212 FLOAT,
    V213 FLOAT,
    V214 FLOAT,
    V215 FLOAT,
    V216 FLOAT,
    V217 FLOAT,
    V218 FLOAT,
    V219 FLOAT,
    V220 FLOAT,
    V221 FLOAT,
    V222 FLOAT,
    V223 FLOAT,
    V224 FLOAT,
    V225 FLOAT,
    V226 FLOAT,
    V227 FLOAT,
    V228 FLOAT,
    V229 FLOAT,
    V230 FLOAT,
    V231 FLOAT,
    V232 FLOAT,
    V233 FLOAT,
    V234 FLOAT,
    V235 FLOAT,
    V236 FLOAT,
    V237 FLOAT,
    V238 FLOAT,
    V239 FLOAT,
    V240 FLOAT,
    V241 FLOAT,
    V242 FLOAT,
    V243 FLOAT,
    V244 FLOAT,
    V245 FLOAT,
    V246 FLOAT,
    V247 FLOAT,
    V248 FLOAT,
    V249 FLOAT,
    V250 FLOAT,
    V251 FLOAT,
    V252 FLOAT,
    V253 FLOAT,
    V254 FLOAT,
    V255 FLOAT,
    V256 FLOAT,
    V257 FLOAT,
    V258 FLOAT,
    V259 FLOAT,
    V260 FLOAT,
    V261 FLOAT,
    V262 FLOAT,
    V263 FLOAT,
    V264 FLOAT,
    V265 FLOAT,
    V266 FLOAT,
    V267 FLOAT,
    V268 FLOAT,
    V269 FLOAT,
    V270 FLOAT,
    V271 FLOAT,
    V272 FLOAT,
    V273 FLOAT,
    V274 FLOAT,
    V275 FLOAT,
    V276 FLOAT,
    V277 FLOAT,
    V278 FLOAT,
    V279 FLOAT,
    V280 FLOAT,
    V281 FLOAT,
    V282 FLOAT,
    V283 FLOAT,
    V284 FLOAT,
    V285 FLOAT,
    V286 FLOAT,
    V287 FLOAT,
    V288 FLOAT,
    V289 FLOAT,
    V290 FLOAT,
    V291 FLOAT,
    V292 FLOAT,
    V293 FLOAT,
    V294 FLOAT,
    V295 FLOAT,
    V296 FLOAT,
    V297 FLOAT,
    V298 FLOAT,
    V299 FLOAT,
    V300 FLOAT,
    V301 FLOAT,
    V302 FLOAT,
    V303 FLOAT,
    V304 FLOAT,
    V305 FLOAT,
    V306 FLOAT,
    V307 FLOAT,
    V308 FLOAT,
    V309 FLOAT,
    V310 FLOAT,
    V311 FLOAT,
    V312 FLOAT,
    V313 FLOAT,
    V314 FLOAT,
    V315 FLOAT,
    V316 FLOAT,
    V317 FLOAT,
    V318 FLOAT,
    V319 FLOAT,
    V320 FLOAT,
    V321 FLOAT,
    TransactionDT FLOAT NOT NULL,
    `Timestamp` TIMESTAMP(3) NOT NULL,
    PRIMARY KEY (TransactionID) NOT ENFORCED,
    WATERMARK FOR `Timestamp` AS `Timestamp` - INTERVAL '20' SECOND
) WITH ('changelog.mode' = 'append');

/* Join transaction and identity table */
CREATE TABLE `joined_records`AS 
SELECT * 
FROM `transactions` t
LEFT JOIN `identities` i 
ON t.TransactionID = i.TransactionID 
AND i.`Timestamp` BETWEEN t.`Timestamp` - INTERVAL '60' SECOND AND t.`Timestamp`+ INTERVAL '60' SECOND;

/* Add new time-based features */
CREATE TABLE `transformed_records` AS
SELECT 
    event.*,
    EXTRACT(DOY FROM TIMESTAMPADD(SECOND, CAST(`TransactionDT` AS INTEGER), TIMESTAMP '2017-11-30 00:00:00')) AS `dayOfYear`,
    EXTRACT(DOW FROM TIMESTAMPADD(SECOND, CAST(`TransactionDT` AS INTEGER), TIMESTAMP '2017-11-30 00:00:00')) AS `dayOfWeek`,
    EXTRACT(MONTH FROM TIMESTAMPADD(SECOND, CAST(`TransactionDT` AS INTEGER), TIMESTAMP '2017-11-30 00:00:00')) AS `month`
FROM 
    `joined_records` AS event;

/* 
 * Encode all features as a JSON string 
 * (Only needed as a workaround if number of features for model prediction exceeds 84) 
 */
CREATE TABLE `transformed_records_json` AS
SELECT JSON_OBJECT(
    'TransactionID' VALUE T.TransactionID,
    'TransactionDT' VALUE T.TransactionDT,
    'TransactionAmt' VALUE T.TransactionAmt,
    'ProductCD' VALUE T.ProductCD,
    'card1' VALUE T.card1,
    'card2' VALUE T.card2,
    'card3' VALUE T.card3,
    'card4' VALUE T.card4,
    'card5' VALUE T.card5,
    'card6' VALUE T.card6,
    'addr1' VALUE T.addr1,
    'addr2' VALUE T.addr2,
    'P_emaildomain' VALUE T.P_emaildomain,
    'C1' VALUE T.C1,
    'C2' VALUE T.C2,
    'C3' VALUE T.C3,
    'C4' VALUE T.C4,
    'C5' VALUE T.C5,
    'C6' VALUE T.C6,
    'C7' VALUE T.C7,
    'C8' VALUE T.C8,
    'C9' VALUE T.C9,
    'C10' VALUE T.C10,
    'C11' VALUE T.C11,
    'C12' VALUE T.C12,
    'C13' VALUE T.C13,
    'C14' VALUE T.C14,
    'D1' VALUE T.D1,
    'D4' VALUE T.D4,
    'D10' VALUE T.D10,
    'D15' VALUE T.D15,
    'M6' VALUE T.M6,
    'V12' VALUE T.V12,
    'V13' VALUE T.V13,
    'V14' VALUE T.V14,
    'V15' VALUE T.V15,
    'V16' VALUE T.V16,
    'V17' VALUE T.V17,
    'V18' VALUE T.V18,
    'V19' VALUE T.V19,
    'V20' VALUE T.V20,
    'V21' VALUE T.V21,
    'V22' VALUE T.V22,
    'V23' VALUE T.V23,
    'V24' VALUE T.V24,
    'V25' VALUE T.V25,
    'V26' VALUE T.V26,
    'V27' VALUE T.V27,
    'V28' VALUE T.V28,
    'V29' VALUE T.V29,
    'V30' VALUE T.V30,
    'V31' VALUE T.V31,
    'V32' VALUE T.V32,
    'V33' VALUE T.V33,
    'V34' VALUE T.V34,
    'V35' VALUE T.V35,
    'V36' VALUE T.V36,
    'V37' VALUE T.V37,
    'V38' VALUE T.V38,
    'V39' VALUE T.V39,
    'V40' VALUE T.V40,
    'V41' VALUE T.V41,
    'V42' VALUE T.V42,
    'V43' VALUE T.V43,
    'V44' VALUE T.V44,
    'V45' VALUE T.V45,
    'V46' VALUE T.V46,
    'V47' VALUE T.V47,
    'V48' VALUE T.V48,
    'V49' VALUE T.V49,
    'V50' VALUE T.V50,
    'V51' VALUE T.V51,
    'V52' VALUE T.V52,
    'V53' VALUE T.V53,
    'V54' VALUE T.V54,
    'V55' VALUE T.V55,
    'V56' VALUE T.V56,
    'V57' VALUE T.V57,
    'V58' VALUE T.V58,
    'V59' VALUE T.V59,
    'V60' VALUE T.V60,
    'V61' VALUE T.V61,
    'V62' VALUE T.V62,
    'V63' VALUE T.V63,
    'V64' VALUE T.V64,
    'V65' VALUE T.V65,
    'V66' VALUE T.V66,
    'V67' VALUE T.V67,
    'V68' VALUE T.V68,
    'V69' VALUE T.V69,
    'V70' VALUE T.V70,
    'V71' VALUE T.V71,
    'V72' VALUE T.V72,
    'V73' VALUE T.V73,
    'V74' VALUE T.V74,
    'V75' VALUE T.V75,
    'V76' VALUE T.V76,
    'V77' VALUE T.V77,
    'V78' VALUE T.V78,
    'V79' VALUE T.V79,
    'V80' VALUE T.V80,
    'V81' VALUE T.V81,
    'V82' VALUE T.V82,
    'V83' VALUE T.V83,
    'V84' VALUE T.V84,
    'V85' VALUE T.V85,
    'V86' VALUE T.V86,
    'V87' VALUE T.V87,
    'V88' VALUE T.V88,
    'V89' VALUE T.V89,
    'V90' VALUE T.V90,
    'V91' VALUE T.V91,
    'V92' VALUE T.V92,
    'V93' VALUE T.V93,
    'V94' VALUE T.V94,
    'V95' VALUE T.V95,
    'V96' VALUE T.V96,
    'V97' VALUE T.V97,
    'V98' VALUE T.V98,
    'V99' VALUE T.V99,
    'V100' VALUE T.V100,
    'V101' VALUE T.V101,
    'V102' VALUE T.V102,
    'V103' VALUE T.V103,
    'V104' VALUE T.V104,
    'V105' VALUE T.V105,
    'V106' VALUE T.V106,
    'V107' VALUE T.V107,
    'V108' VALUE T.V108,
    'V109' VALUE T.V109,
    'V110' VALUE T.V110,
    'V111' VALUE T.V111,
    'V112' VALUE T.V112,
    'V113' VALUE T.V113,
    'V114' VALUE T.V114,
    'V115' VALUE T.V115,
    'V116' VALUE T.V116,
    'V117' VALUE T.V117,
    'V118' VALUE T.V118,
    'V119' VALUE T.V119,
    'V120' VALUE T.V120,
    'V121' VALUE T.V121,
    'V122' VALUE T.V122,
    'V123' VALUE T.V123,
    'V124' VALUE T.V124,
    'V125' VALUE T.V125,
    'V126' VALUE T.V126,
    'V127' VALUE T.V127,
    'V128' VALUE T.V128,
    'V129' VALUE T.V129,
    'V130' VALUE T.V130,
    'V131' VALUE T.V131,
    'V132' VALUE T.V132,
    'V133' VALUE T.V133,
    'V134' VALUE T.V134,
    'V135' VALUE T.V135,
    'V136' VALUE T.V136,
    'V137' VALUE T.V137,
    'V279' VALUE T.V279,
    'V280' VALUE T.V280,
    'V281' VALUE T.V281,
    'V282' VALUE T.V282,
    'V283' VALUE T.V283,
    'V284' VALUE T.V284,
    'V285' VALUE T.V285,
    'V286' VALUE T.V286,
    'V287' VALUE T.V287,
    'V288' VALUE T.V288,
    'V289' VALUE T.V289,
    'V290' VALUE T.V290,
    'V291' VALUE T.V291,
    'V292' VALUE T.V292,
    'V293' VALUE T.V293,
    'V294' VALUE T.V294,
    'V295' VALUE T.V295,
    'V296' VALUE T.V296,
    'V297' VALUE T.V297,
    'V298' VALUE T.V298,
    'V299' VALUE T.V299,
    'V300' VALUE T.V300,
    'V301' VALUE T.V301,
    'V302' VALUE T.V302,
    'V303' VALUE T.V303,
    'V304' VALUE T.V304,
    'V305' VALUE T.V305,
    'V306' VALUE T.V306,
    'V307' VALUE T.V307,
    'V308' VALUE T.V308,
    'V309' VALUE T.V309,
    'V310' VALUE T.V310,
    'V311' VALUE T.V311,
    'V312' VALUE T.V312,
    'V313' VALUE T.V313,
    'V314' VALUE T.V314,
    'V315' VALUE T.V315,
    'V316' VALUE T.V316,
    'V317' VALUE T.V317,
    'V318' VALUE T.V318,
    'V319' VALUE T.V319,
    'V320' VALUE T.V320,
    'V321' VALUE T.V321,
    'DT_D' VALUE T.dayOfYear,
    'DT_W' VALUE T.dayOfWeek,
    'DT_M' VALUE T.`month`,
    'id_01' VALUE T.id_01,
    'id_02' VALUE T.id_02,
    'id_05' VALUE T.id_05,
    'id_06' VALUE T.id_06,
    'id_11' VALUE T.id_11,
    'id_12' VALUE T.id_12,
    'id_13' VALUE T.id_13,
    'id_15' VALUE T.id_15,
    'id_16' VALUE T.id_16,
    'id_17' VALUE T.id_17,
    'id_19' VALUE T.id_19,
    'id_20' VALUE T.id_20,
    'id_28' VALUE T.id_28,
    'id_29' VALUE T.id_29,
    'id_31' VALUE T.id_31,
    'id_35' VALUE T.id_35,
    'id_36' VALUE T.id_36,
    'id_37' VALUE T.id_37,
    'id_38' VALUE T.id_38,
    'DeviceType' VALUE T.DeviceType,
    'DeviceInfo' VALUE T.DeviceInfo
) AS InputJson
FROM `transformed_records` AS T;
